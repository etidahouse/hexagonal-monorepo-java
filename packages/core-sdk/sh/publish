#!/bin/bash

PROJECT_DIR="$(pwd)"
CURRENT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WORKING_DIR="$(dirname "$CURRENT_DIR")"
DIRECTORY_NAME=$(basename "$WORKING_DIR")

echo "$DIRECTORY_NAME"

# Check for uncommitted changes
if [[ -n $(git status -s) ]]; then
    echo "There are uncommitted changes. Exiting "$DIRECTORY_NAME""
    exit 1
fi

# Assuming pom.xml is in the root of the project
POM_FILE=pom.xml

# Extract versions using Maven commands
MAIN_VERSION=$(mvn help:evaluate -Dexpression=project.version -f "$POM_FILE" -DforceStdout -Dgit.ref=origin/main)
CURRENT_VERSION=$(mvn help:evaluate -Dexpression=project.version -f "$POM_FILE" -DforceStdout -Dgit.ref=HEAD)

# Compare versions
if [ "$MAIN_VERSION" != "$CURRENT_VERSION" ]; then
    echo "The version in $POM_FILE has changed. Continuing with Maven deploy..."
else
    echo "The version in $POM_FILE is the same. Exiting without Maven deploy."
    exit 0
fi


if [ ! "$(command -v docker)" ]; then
    echo "docker could not be found"
    exit 0
fi


echo "$DIRECTORY_NAME" Publishing...


docker run -it --rm \
    --name maven-3.8.5-openjdk-17-slim \
    -v "$WORKING_DIR":/opt/maven/ \
    -v "$PROJECT_DIR"/.m2:/root/.m2/repository \
    -w /opt/maven \
    -e GITHUB_USERNAME="$GITHUB_USERNAME" \
    -e GITHUB_TOKEN="$GITHUB_TOKEN" \
    maven:3.8.5-openjdk-17-slim \
    mvn clean deploy
